# MCPエディタ統合サーバー 技術設計書 レビュー結果

**レビュー日**: 2025-11-08
**レビュアー**: ずんだもん
**対象文書**: technical-design.md v1.0

---

## レビュー総評

技術設計書は全体として**高品質**なのだ。要件定義書との整合性が取れており、システムアーキテクチャ、TypeScriptインターフェース、セキュリティ設計が明確に定義されているのだ。

**総合評価**: ⭐⭐⭐⭐☆ (4/5)

---

## 良い点 ✅

### 1. アーキテクチャ設計
- 4層構造（プロトコル層、セキュリティ層、ビジネスロジック層、アダプター層）が明確
- レイヤー間の責務分離が適切
- アダプターパターンによるエディタ抽象化が優れている

### 2. データフロー図
- ファイル読み取り、コード編集、ターミナル実行の3つの主要フローを網羅
- 各ステップが具体的で実装イメージが湧きやすい

### 3. TypeScriptインターフェース定義
- 11種類のMCPツールに対応する詳細なインターフェース
- コメントが適切で、型定義が明確
- JSONスキーマとの対応が取れている

### 4. セキュリティ設計
- パス検証、コマンドサニタイゼーション、監査ログが具体的なコード例付き
- シンボリックリンクのチェックなど、細かい考慮がされている
- 危険なコマンドのパターンが包括的

### 5. エラーハンドリング
- エラー分類が適切
- リトライ戦略（エクスポネンシャルバックオフ）が実装可能な形で記載

### 6. パフォーマンス要件
- レスポンスタイム目標が具体的
- 同時実行制御（セマフォ）の実装例が明確
- 大容量ファイル対策が示されている

---

## 改善が必要な点 🔧

### 🔴 重要度: 高

#### 1. **実装ディレクトリ構造が不明確**

**問題点**:
- デプロイメントセクション（10.1）のディレクトリ構造が `mcp-editor-server/` となっているが、実際は `servers/unity_check/` に実装すべき
- プロジェクト全体の構造が見えない

**推奨事項**:
```
servers/unity_check/
├── src/
│   ├── server/
│   ├── managers/
│   ├── security/
│   ├── adapters/
│   ├── types/
│   └── index.ts
├── tests/
├── package.json
├── tsconfig.json
└── README.md
```

---

#### 2. **ビルドツール自動検出ロジックの詳細不足**

**問題点**:
- `execute_build` ツールで「プロジェクトタイプを自動検出」とあるが、具体的な検出方法が不明

**推奨事項**:
- package.json の存在 → npm/yarn/pnpm
- pom.xml の存在 → Maven
- build.gradle の存在 → Gradle
- *.csproj の存在 → MSBuild

のような検出ロジックを明記すべき

---

#### 3. **エンコーディング自動検出の実装詳細不足**

**問題点**:
- `read_file` でエンコーディング自動検出を謳っているが、実装方法が不明

**推奨事項**:
- 使用するライブラリを明記（例: `chardet`, `encoding-japanese`）
- フォールバック戦略を記載（BOMチェック → chardet → UTF-8デフォルト）

---

#### 4. **依存パッケージのリストが不足**

**問題点**:
- TypeScript、Node.js以外の依存関係が明記されていない

**推奨事項**:
以下のような依存関係セクションを追加すべき：
```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.0.0",
    "chardet": "^1.3.0",
    "encoding-japanese": "^2.0.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "jest": "^29.0.0",
    "@types/node": "^18.0.0"
  }
}
```

---

### 🟡 重要度: 中

#### 5. **バックアップ戦略の詳細不足**

**問題点**:
- `.backup` ディレクトリにバックアップを作成するとあるが、詳細が不明
- バックアップファイルの命名規則、保存期間、容量制限が不明確

**推奨事項**:
```typescript
// バックアップファイル命名規則
const backupPath = `${projectRoot}/.backup/${relativePath}.${timestamp}.bak`;

// 保存期間: 7日間
// 最大保存数: ファイルあたり10世代
// 容量制限: .backupディレクトリ全体で100MB
```

---

#### 6. **接続管理・再接続ロジックの詳細不足**

**問題点**:
- 非機能要件で「自動再接続」が要求されているが、実装詳細が不明

**推奨事項**:
- 再接続戦略（最大リトライ回数、待機時間）を明記
- ハートビート機能の実装を追加

---

#### 7. **Unity Editor統合の詳細不足**

**問題点**:
- Unity Editorアダプターが「オプション」として記載されているのみ
- Unity固有のAPI連携方法が不明確

**推奨事項**:
- Unity Editor連携方法を明記（Unity C# API、外部プロセス通信等）
- Unity特有の考慮事項を追加（プレイモード、シーン管理等）

---

#### 8. **設定ファイルの具体例不足**

**問題点**:
- `package.json`, `tsconfig.json` の具体的な内容が不明確

**推奨事項**:
設計書に以下のような具体例を追加すべき：

**package.json**:
```json
{
  "name": "@mcp-servers/unity-check",
  "version": "1.0.0",
  "main": "dist/index.js",
  "scripts": {
    "build": "tsc",
    "test": "jest",
    "start": "node dist/index.js"
  }
}
```

**tsconfig.json**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true
  }
}
```

---

### 🟢 重要度: 低

#### 9. **ログローテーション戦略の不足**

**問題点**:
- 監査ログが無限に増大する可能性

**推奨事項**:
- ログローテーション戦略を追加（日次ローテーション、最大ファイルサイズ等）
- ログライブラリの使用を検討（例: `winston`, `pino`）

---

#### 10. **パフォーマンスメトリクス収集方法の不足**

**問題点**:
- レスポンスタイム目標は記載されているが、実際の測定・監視方法が不明

**推奨事項**:
- メトリクス収集のための実装を追加（例: `performance.now()`）
- モニタリングツールとの統合を検討

---

#### 11. **ツール定義に`ToolDefinition`型が不足**

**問題点**:
- `IMCPServer.listTools()` が `ToolDefinition[]` を返すが、`ToolDefinition` 型の定義がない

**推奨事項**:
```typescript
interface ToolDefinition {
  name: string;
  description: string;
  inputSchema: JSONSchema;
}
```
を追加すべき

---

## 追加推奨事項 💡

### 1. **接続プロトコルの詳細化**
- stdio, HTTP, WebSocketなど、MCPサーバーがサポートする接続方式を明記すべき

### 2. **エディタ設定の取得方法**
- インデント設定、フォーマット設定をエディタから取得する方法を詳細化すべき

### 3. **マルチワークスペース対応**
- 複数のプロジェクトを同時に開いている場合の挙動を定義すべき

### 4. **バージョニング戦略**
- MCPプロトコルバージョンの互換性管理方法を追加すべき

---

## アクションアイテム 📋

| 優先度 | 項目 | 担当 | 期限 |
|-------|------|------|------|
| 🔴 高 | 実装ディレクトリ構造を `servers/unity_check/` に修正 | ずんだもん | 即時 |
| 🔴 高 | 依存パッケージリストを追加 | ずんだもん | 即時 |
| 🔴 高 | ビルドツール検出ロジックを詳細化 | 開発者 | フェーズ1 |
| 🟡 中 | package.json, tsconfig.json の具体例を追加 | ずんだもん | 即時 |
| 🟡 中 | バックアップ戦略を詳細化 | 開発者 | フェーズ1 |
| 🟢 低 | ログローテーション戦略を追加 | 開発者 | フェーズ2 |

---

## 結論

本技術設計書は**実装に十分な品質**を備えているのだ。上記の改善点を反映することで、さらに完成度の高い設計書になるのだ。

特に「実装ディレクトリ構造の明確化」と「依存パッケージリストの追加」は**即時対応すべき**なのだ。

**レビュー承認**: ✅ **条件付き承認**（重要度:高の項目を修正後、本承認）

---

**次のステップ**:
1. 設計書に上記改善点を反映する
2. package.json と tsconfig.json の具体例を作成する
3. ビルドツール検出ロジックの詳細設計を行う
4. テクニカルアーキテクトによる再レビューを実施する
