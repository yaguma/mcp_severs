# MCPエディタ統合サーバー 要件定義書

## 1. プロジェクト概要

### 1.1 目的
MCPプロトコルを通じてエディタ（Visual Studio Code、Unity Editorなど）とAIエージェントを統合し、AIによる直接的なコード編集とプロジェクト管理を実現するサーバーを構築する。

### 1.2 スコープ
本プロジェクトは、MCPサーバーとして動作し、複数のエディタとの通信インターフェースを提供し、AIエージェントがエディタを制御できるようにすることを目的とする。

---

## 2. 機能要件（EARS記法）

### 2.1 ファイル操作機能

#### FR-2.1.1 ファイル読み取り
**Ubiquitous（普遍的要件）**
- システムは、プロジェクト内の任意のテキストファイルを読み取ることができなければならない
- システムは、バイナリファイルの読み取りをサポートしなければならない
- システムは、ファイルのエンコーディングを自動検出しなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからファイル読み取りリクエストを受信した場合、システムは指定されたファイルの内容を返さなければならない
- ファイルが存在しない場合、システムは適切なエラーメッセージを返さなければならない
- ファイルへのアクセス権限がない場合、システムは権限エラーを返さなければならない

**Unwanted behaviors（望ましくない動作の回避）**
- もし大容量ファイル（10MB以上）の読み取りが要求された場合、システムはストリーミング読み取りまたは部分読み取りを提案しなければならない

**受け入れ基準**
- [ ] 指定されたパスのファイルを正しく読み取れること
- [ ] UTF-8、Shift-JIS、EUC-JPなどの一般的なエンコーディングを自動検出できること
- [ ] 存在しないファイルに対して適切なエラーハンドリングができること
- [ ] 読み取り権限のないファイルに対してセキュリティエラーを返すこと
- [ ] 10MB以上のファイルに対して警告またはストリーミング読み取りを提供すること

---

#### FR-2.1.2 ファイル書き込み
**Ubiquitous（普遍的要件）**
- システムは、指定されたパスに新規ファイルを作成できなければならない
- システムは、既存ファイルの内容を上書きできなければならない
- システムは、書き込み前にバックアップを作成しなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからファイル書き込みリクエストを受信した場合、システムは指定された内容をファイルに書き込まなければならない
- 書き込みが成功した場合、システムは成功レスポンスと書き込まれたバイト数を返さなければならない
- 書き込みディレクトリが存在しない場合、システムは自動的にディレクトリを作成しなければならない

**Unwanted behaviors（望ましくない動作の回避）**
- もし既存ファイルを上書きする場合、システムは`.backup`ディレクトリにバックアップを作成しなければならない
- もしディスク容量が不足している場合、システムは書き込みを中止し、エラーを返さなければならない

**受け入れ基準**
- [ ] 新規ファイルを正しく作成できること
- [ ] 既存ファイルを上書きする前にバックアップを作成すること
- [ ] 書き込み成功時に正しいバイト数を返すこと
- [ ] 必要に応じて親ディレクトリを自動作成すること
- [ ] ディスク容量不足時に適切にエラーハンドリングできること

---

### 2.2 コード編集機能

#### FR-2.2.1 コード挿入
**Ubiquitous（普遍的要件）**
- システムは、指定された行番号にコードを挿入できなければならない
- システムは、挿入前のインデントレベルを維持しなければならない
- システムは、エディタの現在のフォーマット設定を尊重しなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからコード挿入リクエストを受信した場合、システムは指定された位置にコードを挿入しなければならない
- 挿入位置が無効な場合、システムはエラーメッセージを返さなければならない
- 挿入が成功した場合、システムは変更された行範囲を返さなければならない

**State-driven（状態駆動要件）**
- ファイルがエディタで開かれている間、システムはエディタのカーソル位置を保持しなければならない

**受け入れ基準**
- [ ] 指定された行番号に正しくコードを挿入できること
- [ ] 既存のインデントレベルを維持すること
- [ ] エディタのタブ/スペース設定を尊重すること
- [ ] 無効な行番号に対してエラーを返すこと
- [ ] 変更された行範囲を正確に報告すること

---

#### FR-2.2.2 コード削除
**Ubiquitous（普遍的要件）**
- システムは、指定された行範囲のコードを削除できなければならない
- システムは、削除前に影響範囲を検証しなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからコード削除リクエストを受信した場合、システムは指定された行範囲を削除しなければならない
- 削除が成功した場合、システムは削除された行数を返さなければならない
- 削除範囲が無効な場合、システムはエラーを返さなければならない

**Unwanted behaviors（望ましくない動作の回避）**
- もし削除範囲が100行を超える場合、システムは確認を求めなければならない

**受け入れ基準**
- [ ] 指定された行範囲を正しく削除できること
- [ ] 削除された行数を正確に報告すること
- [ ] 無効な範囲指定に対してエラーを返すこと
- [ ] 大規模な削除（100行以上）に対して確認を求めること

---

#### FR-2.2.3 コード置換
**Ubiquitous（普遍的要件）**
- システムは、指定されたパターンに一致するコードを新しいコードで置換できなければならない
- システムは、正規表現による置換をサポートしなければならない
- システムは、置換のプレビュー機能を提供しなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントから置換リクエストを受信した場合、システムは一致するすべての箇所を置換しなければならない
- 置換が成功した場合、システムは置換件数と影響を受けた行番号を返さなければならない
- 一致するパターンが見つからない場合、システムはゼロ件置換を報告しなければならない

**Optional（オプション要件）**
- 必要に応じて、システムは一致箇所ごとに置換の可否を確認できる

**受け入れ基準**
- [ ] 文字列パターンによる置換が正しく動作すること
- [ ] 正規表現による置換が正しく動作すること
- [ ] 置換前にプレビューを提供すること
- [ ] 置換件数と影響行番号を正確に報告すること
- [ ] 一致なしの場合に適切に処理すること

---

### 2.3 ターミナル・ビルドツール操作機能

#### FR-2.3.1 ターミナルコマンド実行
**Ubiquitous（普遍的要件）**
- システムは、エディタの統合ターミナルでコマンドを実行できなければならない
- システムは、コマンドの標準出力と標準エラー出力をキャプチャしなければならない
- システムは、長時間実行されるコマンドをバックグラウンドで実行できなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからコマンド実行リクエストを受信した場合、システムは指定されたコマンドを実行しなければならない
- コマンドが完了した場合、システムは終了コード、標準出力、標準エラー出力を返さなければならない
- コマンドがタイムアウトした場合、システムはタイムアウトエラーを返さなければならない

**Unwanted behaviors（望ましくない動作の回避）**
- もし危険なコマンド（rm -rf /、format等）が実行されようとした場合、システムは実行を拒否し、警告を返さなければならない
- もしコマンドが1分以上実行されている場合、システムは進捗状況を定期的に報告しなければならない

**受け入れ基準**
- [ ] 一般的なシェルコマンドを正しく実行できること
- [ ] 標準出力と標準エラー出力を正確にキャプチャすること
- [ ] 終了コードを正しく返すこと
- [ ] 危険なコマンドを検出してブロックすること
- [ ] 長時間実行コマンドの進捗を報告すること
- [ ] タイムアウト機能が正しく動作すること

---

#### FR-2.3.2 ビルドツール統合
**Ubiquitous（普遍的要件）**
- システムは、一般的なビルドツール（npm、yarn、maven、gradle、MSBuild等）を認識し実行できなければならない
- システムは、ビルドログを解析してエラーと警告を抽出できなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからビルドリクエストを受信した場合、システムはプロジェクトの種類を検出し適切なビルドコマンドを実行しなければならない
- ビルドが失敗した場合、システムはエラー箇所を特定して報告しなければならない
- ビルドが成功した場合、システムは成功メッセージと生成された成果物を報告しなければならない

**受け入れ基準**
- [ ] npm/yarn/pnpmプロジェクトを検出してビルドできること
- [ ] Maven/Gradleプロジェクトを検出してビルドできること
- [ ] .NET/MSBuildプロジェクトを検出してビルドできること
- [ ] ビルドエラーを正しく解析できること
- [ ] 警告とエラーを区別して報告できること

---

### 2.4 エラー検出・修正提案機能

#### FR-2.4.1 エラー箇所の検出
**Ubiquitous（普遍的要件）**
- システムは、エディタの診断情報（Diagnostics）を取得できなければならない
- システムは、構文エラー、型エラー、lint警告を区別して報告できなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントからエラー検出リクエストを受信した場合、システムは現在のファイルまたはプロジェクト全体のエラーをスキャンしなければならない
- エラーが見つかった場合、システムはファイルパス、行番号、エラーメッセージ、重要度を報告しなければならない

**State-driven（状態駆動要件）**
- ファイルが編集されている間、システムはリアルタイムでエラー情報を更新しなければならない

**受け入れ基準**
- [ ] 構文エラーを正しく検出できること
- [ ] 型エラーを正しく検出できること
- [ ] Lint警告を正しく検出できること
- [ ] エラー位置（ファイル、行、列）を正確に報告すること
- [ ] エラーの重要度（Error/Warning/Info）を区別できること

---

#### FR-2.4.2 修正提案の実行
**Ubiquitous（普遍的要件）**
- システムは、エディタが提供するクイックフィックス（Quick Fix）を取得できなければならない
- システムは、AIが生成した修正提案を適用できなければならない

**Event-driven（イベント駆動要件）**
- AIエージェントから修正提案の適用リクエストを受信した場合、システムは指定された修正をコードに適用しなければならない
- 修正が成功した場合、システムは変更内容のdiffを返さなければならない
- 修正が競合を引き起こす場合、システムはエラーを返し、手動解決を促さなければならない

**Optional（オプション要件）**
- 必要に応じて、システムは修正のロールバック機能を提供できる

**受け入れ基準**
- [ ] エディタのクイックフィックスを取得できること
- [ ] 修正提案を正しく適用できること
- [ ] 変更内容のdiffを生成できること
- [ ] 競合検出とエラー処理が正しく動作すること
- [ ] 修正のロールバックができること（オプション）

---

## 3. 非機能要件（EARS記法）

### 3.1 パフォーマンス要件

**Ubiquitous（普遍的要件）**
- システムは、ファイル読み取りリクエストに対して500ms以内にレスポンスを返さなければならない
- システムは、コード編集操作に対して200ms以内にレスポンスを返さなければならない
- システムは、同時に最大10個のリクエストを処理できなければならない

**受け入れ基準**
- [ ] 小ファイル（<1MB）の読み取りが500ms以内に完了すること
- [ ] コード挿入・削除・置換が200ms以内に完了すること
- [ ] 10個の同時リクエストを処理できること

---

### 3.2 セキュリティ要件

**Ubiquitous（普遍的要件）**
- システムは、プロジェクトディレクトリ外へのアクセスを禁止しなければならない
- システムは、危険なコマンドの実行をブロックしなければならない
- システムは、すべての操作をログに記録しなければならない

**Event-driven（イベント駆動要件）**
- 不正なパスアクセスが試みられた場合、システムはアクセスを拒否し、セキュリティログに記録しなければならない

**受け入れ基準**
- [ ] プロジェクトディレクトリ外へのアクセスがブロックされること
- [ ] 危険なコマンド（rm -rf、format等）がブロックされること
- [ ] すべての操作が監査ログに記録されること

---

### 3.3 互換性要件

**Ubiquitous（普遍的要件）**
- システムは、Visual Studio Code 1.80以降と互換性がなければならない
- システムは、Unity Editor 2021.3以降と互換性がなければならない（オプション）
- システムは、Windows、macOS、Linuxで動作しなければならない

**受け入れ基準**
- [ ] VS Code 1.80以降で動作すること
- [ ] Windows 10/11で動作すること
- [ ] macOS 12以降で動作すること
- [ ] Ubuntu 20.04以降で動作すること

---

### 3.4 信頼性要件

**Ubiquitous（普遍的要件）**
- システムは、エラーが発生した場合でもクラッシュしてはならない
- システムは、すべてのエラーを適切にハンドリングし、ログに記録しなければならない

**Unwanted behaviors（望ましくない動作の回避）**
- もしエディタとの接続が切断された場合、システムは自動的に再接続を試みなければならない

**受け入れ基準**
- [ ] エラー発生時にクラッシュしないこと
- [ ] すべてのエラーが適切にログ記録されること
- [ ] 接続断時に自動再接続が試みられること

---

## 4. ユーザーストーリー

### US-1: ファイル内容の読み取り
**As** AIエージェント
**I want to** プロジェクト内のファイル内容を読み取りたい
**So that** コードの分析と理解ができる

**受け入れ基準**
- [ ] ファイルパスを指定してファイル内容を取得できる
- [ ] エンコーディングが自動検出される
- [ ] エラー時に適切なメッセージが返される

---

### US-2: コードの自動修正
**As** AIエージェント
**I want to** 検出されたエラーを自動的に修正したい
**So that** 開発者の作業負担を軽減できる

**受け入れ基準**
- [ ] エラー箇所を検出できる
- [ ] 修正提案を生成できる
- [ ] 修正を適用して検証できる

---

### US-3: ビルドの実行と結果確認
**As** AIエージェント
**I want to** プロジェクトをビルドして結果を確認したい
**So that** 実装が正しく動作することを検証できる

**受け入れ基準**
- [ ] プロジェクトタイプを自動検出できる
- [ ] 適切なビルドコマンドを実行できる
- [ ] ビルドエラーを解析して報告できる

---

### US-4: リファクタリングの実行
**As** AIエージェント
**I want to** コードをリファクタリングしたい
**So that** コード品質を向上させることができる

**受け入れ基準**
- [ ] 変数名や関数名を一括置換できる
- [ ] インデントやフォーマットを自動調整できる
- [ ] リファクタリング前後のdiffを確認できる

---

## 5. 技術的制約

### 5.1 プロトコル
- MCPプロトコル仕様 v1.0以降に準拠すること
- JSON-RPC 2.0を使用した通信を実装すること

### 5.2 プログラミング言語
- TypeScript 5.0以降を使用すること
- Node.js 18.0以降で動作すること

### 5.3 依存関係
- エディタ固有のAPIを抽象化するアダプターパターンを使用すること
- 最小限の外部依存関係で実装すること

---

## 6. 用語集

| 用語 | 定義 |
|------|------|
| MCP | Model Context Protocol - AIエージェントとツールを統合するためのプロトコル |
| エディタ | Visual Studio Code、Unity Editorなどの統合開発環境 |
| AIエージェント | MCPを通じてエディタを制御する人工知能システム |
| クイックフィックス | エディタが提供するコード修正候補 |
| 診断情報 | エラー、警告、情報メッセージなどのコード品質情報 |
| EARS | Easy Approach to Requirements Syntax - 要件記述のための構造化記法 |

---

## 7. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-11-08 | 初版作成 | AI Assistant |

---

## 8. 承認

この要件定義書は、以下の関係者によるレビューと承認が必要です。

- [ ] プロダクトオーナー
- [ ] テクニカルリード
- [ ] セキュリティレビュアー
- [ ] QAリード
