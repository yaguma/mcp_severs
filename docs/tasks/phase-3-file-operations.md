# Phase 3: ファイル操作機能実装（約1ヶ月）

**要件名**: MCPエディタ統合サーバー
**期間**: 2026年1月 - 2026年2月（25営業日、200時間）
**目標**: ファイル読み書き、エンコーディング検出、バックアップ機能の完全実装

---

## タスク一覧

### Week 1: ファイル読み取り機能の実装（5日間、40時間）

#### Day 51: read_file ツールの実装（基本）
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.1](../design/technical-design.md#51-read_file)
- **推定工数**: 8時間
- **タスク**: ファイル読み取りの基本機能を実装する
- **成果物**: `src/managers/FileOperationManager.ts` の `readFile()` メソッド
  - パスの検証
  - ファイル存在チェック
  - ファイルシステムアダプター経由の読み取り
  - 基本的なエラーハンドリング
- **実装詳細**:
  - 設計書 §5.1 の read_file ツールを実装
  - PathValidator でパス検証
  - ファイル存在チェック (fs.existsSync)
  - FileSystemAdapter 経由でファイル読み取り
  - エラーハンドリング (ファイル不存在、権限エラー)
- **テスト要件**:
  - ファイル読み取りの正常系テスト
  - ファイル不存在のテスト
  - プロジェクト外パスのテスト
  - 権限エラーのテスト
- **依存関係**: Phase 2 完了
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイルが正常に読み取れること
  - [ ] 存在しないファイルでエラーが返ること
  - [ ] プロジェクト外のパスでエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 52: エンコーディング自動検出の統合
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.1.1](../design/technical-design.md#511-エンコーディング検出)
- **推定工数**: 8時間
- **タスク**: エンコーディング検出器をファイル読み取りに統合する
- **成果物**: `readFile()` メソッドの拡張
  - エンコーディング自動検出
  - BOMチェック
  - chardetによる検出
  - 日本語エンコーディング対応
- **実装詳細**:
  - 設計書 §5.1.1 のエンコーディング検出を統合
  - EncodingDetector を使用してBOMチェック
  - chardet ライブラリで文字コード検出
  - Shift-JIS, EUC-JP, UTF-8 の自動判定
  - 検出されたエンコーディングでデコード
- **テスト要件**:
  - UTF-8ファイルの読み取りテスト
  - Shift-JISファイルの読み取りテスト
  - EUC-JPファイルの読み取りテスト
  - BOM付きファイルの処理テスト
- **依存関係**: Day 51
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] UTF-8ファイルが正しく読み取れること
  - [ ] Shift-JISファイルが正しく読み取れること
  - [ ] EUC-JPファイルが正しく読み取れること
  - [ ] BOM付きファイルが正しく処理されること
  - [ ] 統合テストが作成されていること

---

#### Day 53: 大容量ファイル対策の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §8.2](../design/technical-design.md#82-大容量ファイル対策)
- **推定工数**: 8時間
- **タスク**: ストリーミング読み取りと部分読み取り機能を実装する
- **成果物**: `readFile()` メソッドの拡張
  - ファイルサイズチェック
  - maxSize パラメータの処理
  - ストリーミング読み取り
  - 切り詰め警告
- **実装詳細**:
  - 設計書 §8.2 の大容量ファイル対策を実装
  - fs.statSync でファイルサイズを取得
  - 10MB以上で警告を返す
  - maxSize パラメータで読み取り上限を設定
  - isTruncated フラグで切り詰めを通知
- **テスト要件**:
  - 大容量ファイルの警告テスト
  - maxSize超過時の部分読み取りテスト
  - isTruncatedフラグのテスト
  - ストリーミング読み取りのテスト
- **依存関係**: Day 52
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 10MB以上のファイルで警告が返ること
  - [ ] maxSize を超えるファイルが部分読み取りされること
  - [ ] isTruncated フラグが正しく設定されること
  - [ ] 単体テストが作成されていること

---

#### Day 54: read_file ツール定義の完成
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.1](../design/technical-design.md#51-read_file)
- **推定工数**: 8時間
- **タスク**: MCPツールとして read_file を登録・公開する
- **成果物**:
  - `src/server/tools/ReadFileTool.ts`
  - ツール定義の登録
  - JSONスキーマの完成
  - リクエストハンドラーとの統合
- **実装詳細**:
  - 設計書 §5.1 の read_file ツール定義を実装
  - ReadFileTool クラスを作成
  - JSON Schema でパラメータを定義 (path, encoding, maxSize)
  - RequestHandler に read_file ツールを登録
  - FileOperationManager.readFile() を呼び出し
- **テスト要件**:
  - ツールリスト取得のテスト
  - MCPクライアントからの呼び出しテスト
  - レスポンス形式のテスト
  - E2Eテスト
- **依存関係**: Day 53
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] read_file ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] 正しいレスポンスが返ること
  - [ ] E2Eテストが作成されていること

---

#### Day 55: read_file の包括的テスト
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §10.2](../design/technical-design.md#102-統合テスト)
- **推定工数**: 8時間
- **タスク**: read_file の全機能をカバーするテストを作成する
- **成果物**: `tests/integration/read-file.test.ts`
  - 正常系テスト
  - 異常系テスト（存在しないファイル、権限エラー）
  - エンコーディングテスト
  - 大容量ファイルテスト
- **実装詳細**:
  - 設計書 §10.2 の統合テスト戦略に従ったテスト実装
  - 正常系: 通常のファイル読み取り
  - 異常系: ファイル不存在、権限エラー、パストラバーサル
  - エンコーディング: UTF-8, Shift-JIS, EUC-JP
  - 大容量: 10MB超のファイル、maxSize制限
- **テスト要件**:
  - 正常系テスト
  - 異常系テスト
  - エンコーディングテスト
  - 大容量ファイルテスト
- **依存関係**: Day 54
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] エッジケースがカバーされていること
  - [ ] テストカバレッジが90%以上であること

---

### Week 2: ファイル書き込み機能の実装（5日間、40時間）

#### Day 56: write_file ツールの実装（基本）
- **タスク**: ファイル書き込みの基本機能を実装する
- **成果物**: `src/managers/FileOperationManager.ts` の `writeFile()` メソッド
  - パスの検証
  - 親ディレクトリの作成
  - ファイルシステムアダプター経由の書き込み
  - 書き込みバイト数の返却
- **依存関係**: Day 55
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイルが正常に書き込めること
  - [ ] 親ディレクトリが自動作成されること
  - [ ] 書き込みバイト数が正確であること
  - [ ] 単体テストが作成されていること

---

#### Day 57: バックアップ機能の統合
- **タスク**: 既存ファイル上書き時のバックアップ処理を統合する
- **成果物**: `writeFile()` メソッドの拡張
  - 既存ファイルのチェック
  - バックアップマネージャーとの連携
  - バックアップパスの返却
  - バックアップ失敗時のハンドリング
- **依存関係**: Day 56
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 既存ファイル上書き時にバックアップが作成されること
  - [ ] バックアップファイル名にタイムスタンプが含まれること
  - [ ] バックアップパスがレスポンスに含まれること
  - [ ] 統合テストが作成されていること

---

#### Day 58: エンコーディング指定書き込みの実装
- **タスク**: 指定されたエンコーディングでの書き込みを実装する
- **成果物**: `writeFile()` メソッドの拡張
  - encoding パラメータの処理
  - UTF-8, Shift-JIS, EUC-JP への変換
  - BOM付き書き込みのサポート
- **依存関係**: Day 57
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] UTF-8で書き込めること
  - [ ] Shift-JISで書き込めること
  - [ ] EUC-JPで書き込めること
  - [ ] 単体テストが作成されていること

---

#### Day 59: write_file ツール定義の完成
- **タスク**: MCPツールとして write_file を登録・公開する
- **成果物**:
  - `src/server/tools/WriteFileTool.ts`
  - ツール定義の登録
  - JSONスキーマの完成
  - リクエストハンドラーとの統合
- **依存関係**: Day 58
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] write_file ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] 正しいレスポンスが返ること
  - [ ] E2Eテストが作成されていること

---

#### Day 60: write_file の包括的テスト
- **タスク**: write_file の全機能をカバーするテストを作成する
- **成果物**: `tests/integration/write-file.test.ts`
  - 新規ファイル作成テスト
  - 既存ファイル上書きテスト
  - バックアップ機能テスト
  - エンコーディングテスト
  - ディスク容量不足テスト
- **依存関係**: Day 59
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] エッジケースがカバーされていること
  - [ ] テストカバレッジが90%以上であること

---

### Week 3: ファイル削除・ディレクトリ操作の実装（5日間、40時間）

#### Day 61: ファイル削除機能の実装
- **タスク**: ファイル削除機能を実装する
- **成果物**: `src/managers/FileOperationManager.ts` の `deleteFile()` メソッド
  - パスの検証
  - ファイル存在チェック
  - 削除前のバックアップ作成（オプション）
  - ファイルシステムアダプター経由の削除
- **依存関係**: Day 60
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイルが正常に削除できること
  - [ ] 存在しないファイルでエラーが返ること
  - [ ] バックアップオプションが機能すること
  - [ ] 単体テストが作成されていること

---

#### Day 62: ディレクトリ作成機能の実装
- **タスク**: ディレクトリ作成機能を実装する
- **成果物**: `src/managers/FileOperationManager.ts` の `createDirectory()` メソッド
  - パスの検証
  - 親ディレクトリの再帰的作成
  - 既存ディレクトリのチェック
- **依存関係**: Day 61
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ディレクトリが正常に作成できること
  - [ ] 親ディレクトリも一緒に作成されること
  - [ ] 既存ディレクトリの場合にエラーが返らないこと
  - [ ] 単体テストが作成されていること

---

#### Day 63: ファイルリスト取得機能の実装
- **タスク**: ディレクトリ内のファイル一覧を取得する機能を実装する
- **成果物**: `src/managers/FileOperationManager.ts` の `listFiles()` メソッド
  - ディレクトリの読み取り
  - ファイル/ディレクトリの区別
  - ファイル情報の取得（サイズ、更新日時）
  - グロブパターンのサポート
- **依存関係**: Day 62
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ディレクトリ内のファイル一覧が取得できること
  - [ ] ファイル情報が含まれること
  - [ ] グロブパターンでフィルタできること
  - [ ] 単体テストが作成されていること

---

#### Day 64: ファイル操作の統合ツール実装
- **タスク**: delete_file, create_directory, list_files をMCPツールとして公開する
- **成果物**:
  - `src/server/tools/DeleteFileTool.ts`
  - `src/server/tools/CreateDirectoryTool.ts`
  - `src/server/tools/ListFilesTool.ts`
  - ツール定義の登録
- **依存関係**: Day 63
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 3つのツールがすべて listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 65: ファイル操作の包括的テスト
- **タスク**: すべてのファイル操作をカバーする統合テストを作成する
- **成果物**: `tests/integration/file-operations.test.ts`
  - ファイル削除テスト
  - ディレクトリ作成テスト
  - ファイルリストテスト
  - 複合操作テスト（作成→書き込み→読み取り→削除）
- **依存関係**: Day 64
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] 複合操作が正常に動作すること
  - [ ] テストカバレッジが90%以上であること

---

### Week 4: パフォーマンス最適化とエラーハンドリング（5日間、40時間）

#### Day 66: ファイルキャッシュの実装
- **タスク**: 頻繁に読み取られるファイルをキャッシュする機能を実装する
- **成果物**: `src/utils/FileCache.ts`
  - LRUキャッシュの実装
  - キャッシュサイズの制限
  - キャッシュの無効化（ファイル更新時）
- **依存関係**: Day 65
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] キャッシュが正常に動作すること
  - [ ] キャッシュヒット時のレスポンスが高速であること
  - [ ] ファイル更新時にキャッシュが無効化されること
  - [ ] 単体テストが作成されていること

---

#### Day 67: ファイル監視機能の実装
- **タスク**: ファイルシステムの変更を監視する機能を実装する
- **成果物**: `src/utils/FileWatcher.ts`
  - ファイル変更の検出
  - ディレクトリ変更の検出
  - キャッシュの自動無効化
  - 変更通知のイベント発行
- **依存関係**: Day 66
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイル変更が検出されること
  - [ ] キャッシュが自動で無効化されること
  - [ ] イベントが正しく発行されること
  - [ ] 単体テストが作成されていること

---

#### Day 68: バックアップ復元機能の実装
- **タスク**: バックアップからファイルを復元する機能を実装する
- **成果物**: `src/utils/BackupManager.ts` の `restore()` メソッド拡張
  - バックアップファイルの検索
  - タイムスタンプによる選択
  - 復元処理
  - 復元確認
- **依存関係**: Day 67
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] バックアップから復元できること
  - [ ] 特定のタイムスタンプのバックアップを指定できること
  - [ ] 復元前に確認が求められること
  - [ ] 単体テストが作成されていること

---

#### Day 69: ディスク容量チェック機能の実装
- **タスク**: 書き込み前にディスク容量を確認する機能を実装する
- **成果物**: `src/utils/DiskSpaceChecker.ts`
  - 空き容量の取得
  - 書き込み可能かの判定
  - 警告閾値の設定
- **依存関係**: Day 68
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ディスクの空き容量が取得できること
  - [ ] 容量不足時にエラーが返ること
  - [ ] 警告閾値が機能すること
  - [ ] 単体テストが作成されていること

---

#### Day 70: Phase 3 総合テストとパフォーマンス測定
- **タスク**: Phase 3の完了確認とパフォーマンス測定
- **成果物**:
  - `tests/performance/file-operations-perf.test.ts`
  - Phase 3完了レポート
  - パフォーマンスベンチマーク
- **依存関係**: Day 69
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのファイル操作が動作すること
  - [ ] ファイル読み取りが500ms以内であること
  - [ ] ファイル書き込みが300ms以内であること
  - [ ] キャッシュが効果的に機能していること
  - [ ] テストカバレッジが90%以上であること

---

### Week 5: ドキュメント整備とリファクタリング（5日間、40時間）

#### Day 71: ファイル操作APIドキュメントの作成
- **タスク**: ファイル操作のAPIドキュメントを作成する
- **成果物**: `docs/api/file-operations.md`
  - read_file API仕様
  - write_file API仕様
  - その他のファイル操作API仕様
  - サンプルコード
- **依存関係**: Day 70
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのAPIが文書化されていること
  - [ ] サンプルコードが動作すること
  - [ ] エラーケースが記載されていること

---

#### Day 72: ユーザーガイドの作成
- **タスク**: ファイル操作のユーザーガイドを作成する
- **成果物**: `docs/user-guide/file-operations.md`
  - ファイル読み取りの使い方
  - ファイル書き込みの使い方
  - エンコーディングの扱い方
  - バックアップの管理方法
- **依存関係**: Day 71
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 初心者でも理解できる内容であること
  - [ ] 実用的な例が含まれていること

---

#### Day 73: エラーハンドリングの改善
- **タスク**: ファイル操作のエラーハンドリングを見直す
- **成果物**:
  - より詳細なエラーメッセージ
  - エラーコードの整理
  - リトライ可能エラーの明確化
- **依存関係**: Day 72
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] エラーメッセージが明確であること
  - [ ] エラーコードが一貫していること
  - [ ] リトライ可能なエラーが適切に処理されること

---

#### Day 74: コードレビューとリファクタリング
- **タスク**: Phase 3のコード全体をレビューしリファクタリングする
- **成果物**:
  - コードレビューレポート
  - リファクタリング実施
  - コード品質の向上
- **依存関係**: Day 73
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] Lintエラーがないこと
  - [ ] 重複コードが削減されていること
  - [ ] コードの可読性が向上していること

---

#### Day 75: Phase 3 最終レビューと完了確認
- **タスク**: Phase 3の完全性を確認し、次フェーズへの準備を行う
- **成果物**:
  - Phase 3最終レポート
  - 未解決課題リスト
  - Phase 4への引き継ぎ事項
- **依存関係**: Day 74
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべての機能が完成していること
  - [ ] すべてのテストがパスすること
  - [ ] ドキュメントが整備されていること
  - [ ] 未解決課題が文書化されていること

---

## Phase 3 完了基準

- [ ] read_file ツールが完全に実装されている
- [ ] write_file ツールが完全に実装されている
- [ ] delete_file, create_directory, list_files が実装されている
- [ ] エンコーディング自動検出が動作している
- [ ] バックアップ機能が動作している
- [ ] ファイルキャッシュが実装されている
- [ ] ファイル監視が実装されている
- [ ] ディスク容量チェックが実装されている
- [ ] すべてのファイル操作が設計書の性能要件を満たしている
- [ ] 単体テストカバレッジが90%以上
- [ ] 統合テストがすべてパスする
- [ ] APIドキュメントとユーザーガイドが完成している

---

## Phase 3 成果物サマリー

| カテゴリ | 成果物 | 完了 |
|---------|--------|------|
| ファイル操作 | read_file, write_file, delete_file, create_directory, list_files | ☐ |
| エンコーディング | 自動検出、変換処理 | ☐ |
| バックアップ | 自動バックアップ、復元機能 | ☐ |
| 最適化 | ファイルキャッシュ、ファイル監視 | ☐ |
| セキュリティ | ディスク容量チェック | ☐ |
| テスト | 単体テスト、統合テスト、パフォーマンステスト | ☐ |
| ドキュメント | APIドキュメント、ユーザーガイド | ☐ |

---

**前のフェーズ**: [Phase 2: コア機能実装](./phase-2-core-implementation.md)
**次のフェーズ**: [Phase 4: コード編集機能実装](./phase-4-code-editing.md)
