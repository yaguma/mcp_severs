# Phase 4: コード編集機能実装（約1ヶ月）

**期間**: 2026年2月 - 2026年3月
**目標**: コード挿入・削除・置換・フォーマット機能の完全実装

---

## タスク一覧

### Week 1: コード挿入機能の実装（5日間）

#### Day 76: insert_code ツールの実装（基本）
- **タスク**: コード挿入の基本機能を実装する
- **成果物**: `src/managers/CodeEditorManager.ts` の `insertCode()` メソッド
  - ファイルのオープン
  - 行番号の検証
  - テキストの挿入
  - 変更範囲の計算
- **依存関係**: Phase 3 完了
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 指定行にコードが挿入できること
  - [ ] 変更範囲が正確に返ること
  - [ ] 無効な行番号でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 77: インデント自動調整機能の実装
- **タスク**: 挿入時に既存のインデントレベルを維持する機能を実装する
- **成果物**: `src/utils/IndentManager.ts`
  - インデントレベルの検出
  - タブ/スペースの判定
  - インデント調整処理
  - preserveIndent フラグの処理
- **依存関係**: Day 76
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 既存のインデントレベルが維持されること
  - [ ] タブ/スペース設定が尊重されること
  - [ ] preserveIndent=false 時に調整されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 78: 複数行挿入の実装
- **タスク**: 複数行のコードを一度に挿入する機能を実装する
- **成果物**: `insertCode()` メソッドの拡張
  - 改行コードの処理
  - 各行へのインデント適用
  - 挿入行数の計算
- **依存関係**: Day 77
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 複数行のコードが正しく挿入されること
  - [ ] 各行に適切なインデントが適用されること
  - [ ] linesInserted が正確であること
  - [ ] 統合テストが作成されていること

---

#### Day 79: insert_code ツール定義の完成
- **タスク**: MCPツールとして insert_code を登録・公開する
- **成果物**:
  - `src/server/tools/InsertCodeTool.ts`
  - ツール定義の登録
  - JSONスキーマの完成
  - リクエストハンドラーとの統合
- **依存関係**: Day 78
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] insert_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 80: insert_code の包括的テスト
- **タスク**: insert_code の全機能をカバーするテストを作成する
- **成果物**: `tests/integration/insert-code.test.ts`
  - 単一行挿入テスト
  - 複数行挿入テスト
  - インデント調整テスト
  - エッジケーステスト
- **依存関係**: Day 79
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 2: コード削除機能の実装（5日間）

#### Day 81: delete_code ツールの実装（基本）
- **タスク**: コード削除の基本機能を実装する
- **成果物**: `src/managers/CodeEditorManager.ts` の `deleteCode()` メソッド
  - ファイルのオープン
  - 行範囲の検証
  - テキストの削除
  - 削除行数の計算
- **依存関係**: Day 80
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 指定範囲のコードが削除できること
  - [ ] 削除行数が正確であること
  - [ ] 無効な範囲でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 82: 大規模削除の確認機能実装
- **タスク**: 100行以上の削除時に確認を求める機能を実装する
- **成果物**: `deleteCode()` メソッドの拡張
  - 削除行数のチェック
  - 確認要求の生成
  - requireConfirmation フラグの処理
- **依存関係**: Day 81
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 100行以上の削除時に確認が求められること
  - [ ] requireConfirmation=false 時に確認されないこと
  - [ ] 確認後に正常に削除されること
  - [ ] 単体テストが作成されていること

---

#### Day 83: 削除前のバックアップ機能
- **タスク**: 削除前に該当範囲をバックアップする機能を実装する
- **成果物**: `deleteCode()` メソッドの拡張
  - 削除範囲の抽出
  - バックアップファイルへの保存
  - バックアップパスの返却
- **依存関係**: Day 82
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 削除範囲がバックアップされること
  - [ ] バックアップから復元できること
  - [ ] 統合テストが作成されていること

---

#### Day 84: delete_code ツール定義の完成
- **タスク**: MCPツールとして delete_code を登録・公開する
- **成果物**:
  - `src/server/tools/DeleteCodeTool.ts`
  - ツール定義の登録
  - E2Eテスト
- **依存関係**: Day 83
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] delete_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 85: delete_code の包括的テスト
- **タスク**: delete_code の全機能をカバーするテストを作成する
- **成果物**: `tests/integration/delete-code.test.ts`
  - 小規模削除テスト
  - 大規模削除テスト
  - バックアップテスト
  - エッジケーステスト
- **依存関係**: Day 84
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 3: コード置換機能の実装（5日間）

#### Day 86: replace_code ツールの実装（基本）
- **タスク**: 文字列置換の基本機能を実装する
- **成果物**: `src/managers/CodeEditorManager.ts` の `replaceCode()` メソッド
  - パターンマッチング
  - 文字列置換
  - 置換件数のカウント
  - 影響行の記録
- **依存関係**: Day 85
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 文字列が正しく置換されること
  - [ ] 置換件数が正確であること
  - [ ] 影響を受けた行番号が返ること
  - [ ] 単体テストが作成されていること

---

#### Day 87: 正規表現置換の実装
- **タスク**: 正規表現による置換機能を実装する
- **成果物**: `replaceCode()` メソッドの拡張
  - 正規表現のコンパイル
  - グループキャプチャのサポート
  - isRegex フラグの処理
  - エスケープ処理
- **依存関係**: Day 86
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 正規表現による置換が動作すること
  - [ ] キャプチャグループが使用できること
  - [ ] 無効な正規表現でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 88: 置換プレビュー機能の実装
- **タスク**: 置換前にdiff形式のプレビューを生成する機能を実装する
- **成果物**: `replaceCode()` メソッドの拡張
  - 置換前後のdiff生成
  - unified diff形式のサポート
  - preview フラグの処理
- **依存関係**: Day 87
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] diffプレビューが生成されること
  - [ ] unified diff形式が正しいこと
  - [ ] preview=true 時は置換が実行されないこと
  - [ ] 統合テストが作成されていること

---

#### Day 89: replace_code ツール定義の完成
- **タスク**: MCPツールとして replace_code を登録・公開する
- **成果物**:
  - `src/server/tools/ReplaceCodeTool.ts`
  - ツール定義の登録
  - E2Eテスト
- **依存関係**: Day 88
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] replace_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 90: replace_code の包括的テスト
- **タスク**: replace_code の全機能をカバーするテストを作成する
- **成果物**: `tests/integration/replace-code.test.ts`
  - 文字列置換テスト
  - 正規表現置換テスト
  - プレビューテスト
  - エッジケーステスト
- **依存関係**: Day 89
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 4: フォーマット機能と統合（5日間）

#### Day 91: format_document ツールの実装
- **タスク**: ドキュメント全体のフォーマット機能を実装する
- **成果物**: `src/managers/CodeEditorManager.ts` の `formatDocument()` メソッド
  - エディタのフォーマッターAPIとの連携
  - フォーマット設定の取得
  - フォーマット実行
  - 変更の適用
- **依存関係**: Day 90
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ドキュメントが正しくフォーマットされること
  - [ ] エディタの設定が尊重されること
  - [ ] フォーマッターがない場合にエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 92: 部分フォーマット機能の実装
- **タスク**: 指定範囲のみをフォーマットする機能を実装する
- **成果物**: `formatRange()` メソッドの追加
  - 範囲の指定
  - 部分フォーマットの実行
  - インデントの調整
- **依存関係**: Day 91
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 指定範囲がフォーマットされること
  - [ ] 範囲外が変更されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 93: コード編集後の自動フォーマット
- **タスク**: 編集操作後に自動でフォーマットを適用する機能を実装する
- **成果物**: CodeEditorManager の拡張
  - autoFormat オプションの追加
  - 編集後のフォーマット適用
  - フォーマット失敗時のロールバック
- **依存関係**: Day 92
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] autoFormat=true 時に自動フォーマットされること
  - [ ] フォーマット失敗時に元の編集が維持されること
  - [ ] 統合テストが作成されていること

---

#### Day 94: コード編集のパフォーマンス最適化
- **タスク**: コード編集操作のレスポンスタイムを最適化する
- **成果物**:
  - バッチ編集機能
  - 編集のキューイング
  - 不要な再描画の抑制
- **依存関係**: Day 93
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] コード挿入が200ms以内であること
  - [ ] コード削除が200ms以内であること
  - [ ] コード置換が500ms以内であること
  - [ ] パフォーマンステストが作成されていること

---

#### Day 95: Phase 4 総合テストとベンチマーク
- **タスク**: Phase 4の完了確認とパフォーマンスベンチマーク
- **成果物**:
  - `tests/performance/code-editing-perf.test.ts`
  - Phase 4完了レポート
  - パフォーマンスベンチマーク結果
- **依存関係**: Day 94
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのコード編集機能が動作すること
  - [ ] パフォーマンス要件を満たしていること
  - [ ] テストカバレッジが90%以上であること

---

### Week 5: 高度な編集機能とドキュメント（5日間）

#### Day 96: シンボルリネーム機能の実装
- **タスク**: 変数名・関数名の一括リネーム機能を実装する
- **成果物**: `src/managers/CodeEditorManager.ts` の `renameSymbol()` メソッド
  - シンボルの検出
  - すべての参照箇所の特定
  - 一括置換の実行
- **依存関係**: Day 95
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] シンボルがすべて正しくリネームされること
  - [ ] 文字列リテラル内は置換されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 97: コードスニペット機能の実装
- **タスク**: よく使うコードパターンを挿入する機能を実装する
- **成果物**: `src/utils/SnippetManager.ts`
  - スニペットの定義
  - プレースホルダーの処理
  - タブストップのサポート
- **依存関係**: Day 96
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] スニペットが正しく展開されること
  - [ ] プレースホルダーが機能すること
  - [ ] 単体テストが作成されていること

---

#### Day 98: コード編集APIドキュメントの作成
- **タスク**: コード編集のAPIドキュメントを作成する
- **成果物**: `docs/api/code-editing.md`
  - insert_code API仕様
  - delete_code API仕様
  - replace_code API仕様
  - format_document API仕様
  - サンプルコード
- **依存関係**: Day 97
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのAPIが文書化されていること
  - [ ] サンプルコードが動作すること

---

#### Day 99: ユーザーガイドの作成
- **タスク**: コード編集のユーザーガイドを作成する
- **成果物**: `docs/user-guide/code-editing.md`
  - コード挿入の使い方
  - インデント調整の仕組み
  - 置換とプレビューの使い方
  - フォーマット機能の活用
- **依存関係**: Day 98
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 初心者でも理解できる内容であること
  - [ ] 実用的な例が含まれていること

---

#### Day 100: Phase 4 最終レビューと完了確認
- **タスク**: Phase 4の完全性を確認し、次フェーズへの準備を行う
- **成果物**:
  - Phase 4最終レポート
  - コードレビュー結果
  - Phase 5への引き継ぎ事項
- **依存関係**: Day 99
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべての機能が完成していること
  - [ ] すべてのテストがパスすること
  - [ ] ドキュメントが整備されていること

---

## Phase 4 完了基準

- [ ] insert_code ツールが完全に実装されている
- [ ] delete_code ツールが完全に実装されている
- [ ] replace_code ツールが完全に実装されている
- [ ] format_document ツールが実装されている
- [ ] インデント自動調整が動作している
- [ ] 正規表現置換が動作している
- [ ] プレビュー機能が動作している
- [ ] シンボルリネームが実装されている（オプション）
- [ ] すべてのコード編集が設計書の性能要件を満たしている
- [ ] 単体テストカバレッジが90%以上
- [ ] 統合テストがすべてパスする
- [ ] APIドキュメントとユーザーガイドが完成している

---

## Phase 4 成果物サマリー

| カテゴリ | 成果物 | 完了 |
|---------|--------|------|
| コード編集 | insert_code, delete_code, replace_code, format_document | ☐ |
| インデント | 自動調整、設定尊重 | ☐ |
| 置換 | 文字列置換、正規表現置換、プレビュー | ☐ |
| フォーマット | 全体フォーマット、部分フォーマット、自動フォーマット | ☐ |
| 高度な機能 | シンボルリネーム、スニペット | ☐ |
| テスト | 単体テスト、統合テスト、パフォーマンステスト | ☐ |
| ドキュメント | APIドキュメント、ユーザーガイド | ☐ |

---

**前のフェーズ**: [Phase 3: ファイル操作機能実装](./phase-3-file-operations.md)
**次のフェーズ**: [Phase 5: ターミナル・ビルド機能実装](./phase-5-terminal-build.md)
