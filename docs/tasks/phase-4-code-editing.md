# Phase 4: コード編集機能実装（約1ヶ月）

**要件名**: MCPエディタ統合サーバー
**期間**: 2026年2月 - 2026年3月（25営業日、200時間）
**目標**: コード挿入・削除・置換・フォーマット機能の完全実装

---

## タスク一覧

### Week 1: コード挿入機能の実装（5日間、40時間）

#### Day 76: insert_code ツールの実装（基本）
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.5 の insert_code ツールを実装
  - `src/managers/CodeEditorManager.ts` に `insertCode()` メソッドを追加
  - ファイルのオープンと行番号の検証
  - 指定行へのテキスト挿入処理
  - 変更範囲 (startLine, endLine, linesInserted) の計算
  - エラーハンドリング（無効な行番号、ファイル不存在など）
- **テスト要件**:
  - 指定行への正常なコード挿入のテスト
  - 変更範囲が正確に返ることのテスト
  - 無効な行番号でエラーが返ることのテスト
  - ファイル不存在時のエラーテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Phase 3 完了
- **受け入れ基準**:
  - [ ] 指定行にコードが挿入できること
  - [ ] 変更範囲が正確に返ること
  - [ ] 無効な行番号でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 77: インデント自動調整機能の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.5 の preserveIndent オプションを実装
  - `src/utils/IndentManager.ts` を作成
  - インデントレベルの自動検出（正規表現で先頭の空白を検出）
  - タブ/スペースの判定とエディタ設定の取得
  - インデント調整処理（挿入コードの各行にインデントを追加）
  - preserveIndent フラグの処理（true: 自動調整、false: 元のまま）
- **テスト要件**:
  - 既存のインデントレベルが維持されることのテスト
  - タブ設定時のインデント調整のテスト
  - スペース設定時のインデント調整のテスト
  - preserveIndent=false 時に調整されないことのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 76
- **受け入れ基準**:
  - [ ] 既存のインデントレベルが維持されること
  - [ ] タブ/スペース設定が尊重されること
  - [ ] preserveIndent=false 時に調整されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 78: 複数行挿入の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.5 の複数行挿入機能を実装
  - `insertCode()` メソッドを拡張して複数行をサポート
  - 改行コード（\n, \r\n）の正規化処理
  - 各行へのインデント自動適用（IndentManager使用）
  - 挿入行数の正確な計算（linesInserted フィールド）
  - 変更範囲の正確な計算（startLine, endLine）
- **テスト要件**:
  - 複数行のコードが正しく挿入されることのテスト
  - 各行に適切なインデントが適用されることのテスト
  - linesInserted が正確であることのテスト
  - 異なる改行コード（\n, \r\n）での動作テスト
  - 統合テストの作成とカバレッジ90%以上
- **依存関係**: Day 77
- **受け入れ基準**:
  - [ ] 複数行のコードが正しく挿入されること
  - [ ] 各行に適切なインデントが適用されること
  - [ ] linesInserted が正確であること
  - [ ] 統合テストが作成されていること

---

#### Day 79: insert_code ツール定義の完成
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.5 の insert_code ツール定義を完成
  - `src/server/tools/InsertCodeTool.ts` を作成
  - MCP ツール定義の登録（name, description, inputSchema）
  - JSON Schema の完成（filePath, line, code, preserveIndent パラメータ）
  - RequestHandler との統合（insertCode メソッドの呼び出し）
  - レスポンスフォーマットの実装（success, startLine, endLine, linesInserted）
- **テスト要件**:
  - insert_code ツールが listTools() に含まれることのテスト
  - MCPクライアントから呼び出せることのテスト
  - 各パラメータの検証テスト
  - E2Eテストの作成とカバレッジ90%以上
- **依存関係**: Day 78
- **受け入れ基準**:
  - [ ] insert_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 80: insert_code の包括的テスト
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.5 のテスト要件を満たす包括的テストを作成
  - `tests/integration/insert-code.test.ts` を作成
  - 単一行挿入の正常系・異常系テスト
  - 複数行挿入の正常系・異常系テスト
  - インデント調整機能のテスト（タブ・スペース両方）
  - エッジケーステスト（空ファイル、最終行、無効な行番号など）
  - カバレッジレポートの生成
- **テスト要件**:
  - すべてのテストケースがパスすること
  - テストカバレッジが90%以上であること
  - エッジケースが網羅されていること
  - テストの実行時間が合理的であること（< 5秒）
- **依存関係**: Day 79
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 2: コード削除機能の実装（5日間、40時間）

#### Day 81: delete_code ツールの実装（基本）
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.6](../design/technical-design.md#56-delete_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.6 の delete_code ツールを実装
  - `src/managers/CodeEditorManager.ts` に `deleteCode()` メソッドを追加
  - ファイルのオープンと行範囲の検証（startLine, endLine）
  - 指定範囲のテキスト削除処理
  - 削除行数の計算（linesDeleted フィールド）
  - エラーハンドリング（無効な範囲、ファイル不存在など）
- **テスト要件**:
  - 指定範囲のコードが正しく削除されることのテスト
  - 削除行数が正確であることのテスト
  - 無効な範囲（startLine > endLine）でエラーが返ることのテスト
  - ファイル不存在時のエラーテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 80
- **受け入れ基準**:
  - [ ] 指定範囲のコードが削除できること
  - [ ] 削除行数が正確であること
  - [ ] 無効な範囲でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 82: 大規模削除の確認機能実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.6](../design/technical-design.md#56-delete_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.6 の requireConfirmation オプションを実装
  - `deleteCode()` メソッドを拡張して確認機能を追加
  - 削除行数のチェック（endLine - startLine + 1 >= 100）
  - 確認要求の生成（confirmationRequired フラグとメッセージ）
  - requireConfirmation フラグの処理（デフォルト: true）
  - 確認後の削除実行処理
- **テスト要件**:
  - 100行以上の削除時に確認が求められることのテスト
  - requireConfirmation=false 時に確認されないことのテスト
  - 確認後に正常に削除されることのテスト
  - 99行以下の削除時に確認が不要なことのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 81
- **受け入れ基準**:
  - [ ] 100行以上の削除時に確認が求められること
  - [ ] requireConfirmation=false 時に確認されないこと
  - [ ] 確認後に正常に削除されること
  - [ ] 単体テストが作成されていること

---

#### Day 83: 削除前のバックアップ機能
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.6](../design/technical-design.md#56-delete_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.6 のバックアップ機能を実装
  - `deleteCode()` メソッドを拡張してバックアップ処理を追加
  - 削除範囲のテキスト抽出
  - バックアップファイルへの保存（.backup ディレクトリ）
  - バックアップファイル名の生成（タイムスタンプ付き）
  - バックアップパスの返却（backupPath フィールド）
- **テスト要件**:
  - 削除範囲が正しくバックアップされることのテスト
  - バックアップファイルが正しい場所に保存されることのテスト
  - バックアップから復元できることのテスト
  - 複数回削除時のバックアップファイル管理のテスト
  - 統合テストカバレッジ90%以上
- **依存関係**: Day 82
- **受け入れ基準**:
  - [ ] 削除範囲がバックアップされること
  - [ ] バックアップから復元できること
  - [ ] 統合テストが作成されていること

---

#### Day 84: delete_code ツール定義の完成
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.6](../design/technical-design.md#56-delete_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.6 の delete_code ツール定義を完成
  - `src/server/tools/DeleteCodeTool.ts` を作成
  - MCP ツール定義の登録（name, description, inputSchema）
  - JSON Schema の完成（filePath, startLine, endLine, requireConfirmation パラメータ）
  - RequestHandler との統合（deleteCode メソッドの呼び出し）
  - レスポンスフォーマットの実装（success, linesDeleted, backupPath）
- **テスト要件**:
  - delete_code ツールが listTools() に含まれることのテスト
  - MCPクライアントから呼び出せることのテスト
  - 各パラメータの検証テスト
  - E2Eテストの作成とカバレッジ90%以上
- **依存関係**: Day 83
- **受け入れ基準**:
  - [ ] delete_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 85: delete_code の包括的テスト
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.6](../design/technical-design.md#56-delete_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.6 のテスト要件を満たす包括的テストを作成
  - `tests/integration/delete-code.test.ts` を作成
  - 小規模削除（< 100行）の正常系・異常系テスト
  - 大規模削除（>= 100行）と確認機能のテスト
  - バックアップ機能のテスト（保存・復元）
  - エッジケーステスト（空範囲、全行削除、無効な範囲など）
  - カバレッジレポートの生成
- **テスト要件**:
  - すべてのテストケースがパスすること
  - テストカバレッジが90%以上であること
  - エッジケースが網羅されていること
  - テストの実行時間が合理的であること（< 5秒）
- **依存関係**: Day 84
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 3: コード置換機能の実装（5日間、40時間）

#### Day 86: replace_code ツールの実装（基本）
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.7](../design/technical-design.md#57-replace_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.7 の replace_code ツールを実装
  - `src/managers/CodeEditorManager.ts` に `replaceCode()` メソッドを追加
  - パターンマッチング（文字列検索）の実装
  - 文字列置換処理（String.prototype.replace）
  - 置換件数のカウント（replacementCount フィールド）
  - 影響を受けた行番号の記録（affectedLines 配列）
  - エラーハンドリング（パターン不一致など）
- **テスト要件**:
  - 文字列が正しく置換されることのテスト
  - 置換件数が正確であることのテスト
  - 影響を受けた行番号が正しく返ることのテスト
  - パターンが見つからない場合のテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 85
- **受け入れ基準**:
  - [ ] 文字列が正しく置換されること
  - [ ] 置換件数が正確であること
  - [ ] 影響を受けた行番号が返ること
  - [ ] 単体テストが作成されていること

---

#### Day 87: 正規表現置換の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.7](../design/technical-design.md#57-replace_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.7 の isRegex オプションを実装
  - `replaceCode()` メソッドを拡張して正規表現をサポート
  - 正規表現のコンパイル（new RegExp）
  - グループキャプチャのサポート（$1, $2 など）
  - isRegex フラグの処理（デフォルト: false）
  - エスケープ処理（リテラル文字列の場合）
  - 無効な正規表現のエラーハンドリング
- **テスト要件**:
  - 正規表現による置換が正しく動作することのテスト
  - キャプチャグループ（$1, $2）が使用できることのテスト
  - 無効な正規表現でエラーが返ることのテスト
  - グローバルフラグ（/g）の動作テスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 86
- **受け入れ基準**:
  - [ ] 正規表現による置換が動作すること
  - [ ] キャプチャグループが使用できること
  - [ ] 無効な正規表現でエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 88: 置換プレビュー機能の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.7](../design/technical-design.md#57-replace_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.7 の preview オプションを実装
  - `replaceCode()` メソッドを拡張してプレビュー機能を追加
  - 置換前後のdiff生成（unified diff形式）
  - diff ライブラリの活用（例: diff パッケージ）
  - preview フラグの処理（true: プレビューのみ、false: 実行）
  - プレビュー結果の返却（previewDiff フィールド）
- **テスト要件**:
  - diffプレビューが正しく生成されることのテスト
  - unified diff形式が正しいことのテスト
  - preview=true 時に置換が実行されないことのテスト
  - preview=false 時に通常通り置換されることのテスト
  - 統合テストカバレッジ90%以上
- **依存関係**: Day 87
- **受け入れ基準**:
  - [ ] diffプレビューが生成されること
  - [ ] unified diff形式が正しいこと
  - [ ] preview=true 時は置換が実行されないこと
  - [ ] 統合テストが作成されていること

---

#### Day 89: replace_code ツール定義の完成
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.7](../design/technical-design.md#57-replace_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.7 の replace_code ツール定義を完成
  - `src/server/tools/ReplaceCodeTool.ts` を作成
  - MCP ツール定義の登録（name, description, inputSchema）
  - JSON Schema の完成（filePath, pattern, replacement, isRegex, preview パラメータ）
  - RequestHandler との統合（replaceCode メソッドの呼び出し）
  - レスポンスフォーマットの実装（success, replacementCount, affectedLines, previewDiff）
- **テスト要件**:
  - replace_code ツールが listTools() に含まれることのテスト
  - MCPクライアントから呼び出せることのテスト
  - 各パラメータの検証テスト
  - E2Eテストの作成とカバレッジ90%以上
- **依存関係**: Day 88
- **受け入れ基準**:
  - [ ] replace_code ツールが listTools() に含まれること
  - [ ] MCPクライアントから呼び出せること
  - [ ] E2Eテストが作成されていること

---

#### Day 90: replace_code の包括的テスト
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.7](../design/technical-design.md#57-replace_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.7 のテスト要件を満たす包括的テストを作成
  - `tests/integration/replace-code.test.ts` を作成
  - 文字列置換の正常系・異常系テスト
  - 正規表現置換のテスト（キャプチャグループ含む）
  - プレビュー機能のテスト
  - エッジケーステスト（パターン不一致、無効な正規表現など）
  - カバレッジレポートの生成
- **テスト要件**:
  - すべてのテストケースがパスすること
  - テストカバレッジが90%以上であること
  - エッジケースが網羅されていること
  - テストの実行時間が合理的であること（< 5秒）
- **依存関係**: Day 89
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが90%以上であること

---

### Week 4: フォーマット機能と統合（5日間、40時間）

#### Day 91: format_document ツールの実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.8](../design/technical-design.md#58-format_document)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.8 の format_document ツールを実装
  - `src/managers/CodeEditorManager.ts` に `formatDocument()` メソッドを追加
  - エディタのフォーマッターAPIとの連携
  - フォーマット設定の取得（タブ幅、インデントスタイルなど）
  - フォーマット実行と変更の適用
  - エラーハンドリング（フォーマッター不在、フォーマット失敗など）
- **テスト要件**:
  - ドキュメントが正しくフォーマットされることのテスト
  - エディタの設定が尊重されることのテスト
  - フォーマッターがない場合にエラーが返ることのテスト
  - 異なる言語（TypeScript, JavaScript, JSON）でのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 90
- **受け入れ基準**:
  - [ ] ドキュメントが正しくフォーマットされること
  - [ ] エディタの設定が尊重されること
  - [ ] フォーマッターがない場合にエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 92: 部分フォーマット機能の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.8](../design/technical-design.md#58-format_document)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.8 の部分フォーマット機能を実装
  - `src/managers/CodeEditorManager.ts` に `formatRange()` メソッドを追加
  - 範囲の指定（startLine, endLine）
  - 部分フォーマットの実行（指定範囲のみ）
  - インデントの調整と周辺行との整合性確保
  - 範囲外が変更されないことの保証
- **テスト要件**:
  - 指定範囲が正しくフォーマットされることのテスト
  - 範囲外が変更されないことのテスト
  - 範囲境界での動作テスト
  - インデントが正しく調整されることのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 91
- **受け入れ基準**:
  - [ ] 指定範囲がフォーマットされること
  - [ ] 範囲外が変更されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 93: コード編集後の自動フォーマット
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.8](../design/technical-design.md#58-format_document)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §5.8 の autoFormat オプションを実装
  - CodeEditorManager を拡張して自動フォーマット機能を追加
  - autoFormat オプションの追加（デフォルト: false）
  - 編集操作（insert, delete, replace）後の自動フォーマット適用
  - フォーマット失敗時のロールバック機能
  - 編集履歴の保持と復元
- **テスト要件**:
  - autoFormat=true 時に自動フォーマットされることのテスト
  - autoFormat=false 時にフォーマットされないことのテスト
  - フォーマット失敗時に元の編集が維持されることのテスト
  - ロールバック機能のテスト
  - 統合テストカバレッジ90%以上
- **依存関係**: Day 92
- **受け入れ基準**:
  - [ ] autoFormat=true 時に自動フォーマットされること
  - [ ] フォーマット失敗時に元の編集が維持されること
  - [ ] 統合テストが作成されていること

---

#### Day 94: コード編集のパフォーマンス最適化
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §9.2](../design/technical-design.md#92-パフォーマンス要件)
- **推定工数**: 8時間
- **実装詳細**:
  - 設計書 §9.2 のパフォーマンス要件を満たす最適化を実装
  - バッチ編集機能の実装（複数の編集を一括処理）
  - 編集のキューイング機構の実装
  - 不要な再描画の抑制（debounce/throttle）
  - キャッシュ機構の最適化
  - 非同期処理の活用
- **テスト要件**:
  - コード挿入が200ms以内であることのテスト
  - コード削除が200ms以内であることのテスト
  - コード置換が500ms以内であることのテスト
  - バッチ編集の正常動作テスト
  - パフォーマンステストの作成とベンチマーク
- **依存関係**: Day 93
- **受け入れ基準**:
  - [ ] コード挿入が200ms以内であること
  - [ ] コード削除が200ms以内であること
  - [ ] コード置換が500ms以内であること
  - [ ] パフォーマンステストが作成されていること

---

#### Day 95: Phase 4 総合テストとベンチマーク
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §9.2](../design/technical-design.md#92-パフォーマンス要件)
- **推定工数**: 8時間
- **実装詳細**:
  - Phase 4の完了確認と総合テストを実施
  - `tests/performance/code-editing-perf.test.ts` を作成
  - すべてのコード編集機能の統合テスト
  - パフォーマンスベンチマークの実行と結果レポート
  - テストカバレッジの測定と確認
  - Phase 4完了レポートの作成
- **テスト要件**:
  - すべてのコード編集機能が正常に動作することのテスト
  - パフォーマンス要件を満たしていることの確認
  - テストカバレッジが90%以上であることの確認
  - エンドツーエンドテストの実行
  - ベンチマーク結果のドキュメント化
- **依存関係**: Day 94
- **受け入れ基準**:
  - [ ] すべてのコード編集機能が動作すること
  - [ ] パフォーマンス要件を満たしていること
  - [ ] テストカバレッジが90%以上であること

---

### Week 5: 高度な編集機能とドキュメント（5日間、40時間）

#### Day 96: シンボルリネーム機能の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5-5.8](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 高度な編集機能としてシンボルリネーム機能を実装
  - `src/managers/CodeEditorManager.ts` に `renameSymbol()` メソッドを追加
  - シンボルの検出（変数名、関数名、クラス名など）
  - すべての参照箇所の特定（AST解析または正規表現）
  - 一括置換の実行（文字列リテラルを除外）
  - スコープの考慮（ローカル変数とグローバル変数の区別）
- **テスト要件**:
  - シンボルがすべて正しくリネームされることのテスト
  - 文字列リテラル内は置換されないことのテスト
  - スコープが正しく考慮されることのテスト
  - 異なるシンボルタイプ（変数、関数、クラス）でのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 95
- **受け入れ基準**:
  - [ ] シンボルがすべて正しくリネームされること
  - [ ] 文字列リテラル内は置換されないこと
  - [ ] 単体テストが作成されていること

---

#### Day 97: コードスニペット機能の実装
- **タスクタイプ**: TDD 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - 高度な編集機能としてコードスニペット機能を実装
  - `src/utils/SnippetManager.ts` を作成
  - スニペットの定義とテンプレート管理
  - プレースホルダーの処理（${1:placeholder}形式）
  - タブストップのサポート（$1, $2, $0など）
  - 変数の展開（$TM_FILENAME, $TM_LINE_NUMBER など）
  - スニペット挿入後のカーソル位置制御
- **テスト要件**:
  - スニペットが正しく展開されることのテスト
  - プレースホルダーが正しく機能することのテスト
  - タブストップが正しく動作することのテスト
  - 変数の展開が正しく行われることのテスト
  - 単体テストカバレッジ90%以上
- **依存関係**: Day 96
- **受け入れ基準**:
  - [ ] スニペットが正しく展開されること
  - [ ] プレースホルダーが機能すること
  - [ ] 単体テストが作成されていること

---

#### Day 98: コード編集APIドキュメントの作成
- **タスクタイプ**: DIRECT 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5-5.8](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - コード編集機能のAPIドキュメントを作成
  - `docs/api/code-editing.md` を作成
  - insert_code API仕様の文書化（パラメータ、レスポンス、エラーコード）
  - delete_code API仕様の文書化
  - replace_code API仕様の文書化
  - format_document API仕様の文書化
  - 各APIのサンプルコード（TypeScript）の作成
  - エラーハンドリングのベストプラクティス
- **依存関係**: Day 97
- **受け入れ基準**:
  - [ ] すべてのAPIが文書化されていること
  - [ ] サンプルコードが動作すること

---

#### Day 99: ユーザーガイドの作成
- **タスクタイプ**: DIRECT 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5-5.8](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - コード編集機能のユーザーガイドを作成
  - `docs/user-guide/code-editing.md` を作成
  - コード挿入の使い方（基本から応用まで）
  - インデント調整の仕組みと設定方法
  - 置換とプレビューの使い方（文字列・正規表現）
  - フォーマット機能の活用方法
  - トラブルシューティングとFAQ
  - 実用的な使用例とユースケース
- **依存関係**: Day 98
- **受け入れ基準**:
  - [ ] 初心者でも理解できる内容であること
  - [ ] 実用的な例が含まれていること

---

#### Day 100: Phase 4 最終レビューと完了確認
- **タスクタイプ**: DIRECT 🔵
- **要件名**: MCPエディタ統合サーバー
- **要件リンク**: [技術設計書 §5.5-5.8](../design/technical-design.md#55-insert_code)
- **推定工数**: 8時間
- **実装詳細**:
  - Phase 4の完全性を確認し、次フェーズへの準備を行う
  - Phase 4最終レポートの作成
  - コードレビューの実施と結果の文書化
  - すべての機能の動作確認
  - テストカバレッジの最終確認
  - ドキュメントの整備と最終チェック
  - Phase 5への引き継ぎ事項の整理
  - 課題と改善点の洗い出し
- **依存関係**: Day 99
- **受け入れ基準**:
  - [ ] すべての機能が完成していること
  - [ ] すべてのテストがパスすること
  - [ ] ドキュメントが整備されていること

---

## Phase 4 完了基準

- [ ] insert_code ツールが完全に実装されている
- [ ] delete_code ツールが完全に実装されている
- [ ] replace_code ツールが完全に実装されている
- [ ] format_document ツールが実装されている
- [ ] インデント自動調整が動作している
- [ ] 正規表現置換が動作している
- [ ] プレビュー機能が動作している
- [ ] シンボルリネームが実装されている（オプション）
- [ ] すべてのコード編集が設計書の性能要件を満たしている
- [ ] 単体テストカバレッジが90%以上
- [ ] 統合テストがすべてパスする
- [ ] APIドキュメントとユーザーガイドが完成している

---

## Phase 4 成果物サマリー

| カテゴリ | 成果物 | 推定工数 | 完了 |
|---------|--------|---------|------|
| コード編集 | insert_code, delete_code, replace_code, format_document | 96時間 | ☐ |
| インデント | 自動調整、設定尊重 | 8時間 | ☐ |
| 置換 | 文字列置換、正規表現置換、プレビュー | 24時間 | ☐ |
| フォーマット | 全体フォーマット、部分フォーマット、自動フォーマット | 24時間 | ☐ |
| 高度な機能 | シンボルリネーム、スニペット | 16時間 | ☐ |
| テスト | 単体テスト、統合テスト、パフォーマンステスト | 16時間 | ☐ |
| ドキュメント | APIドキュメント、ユーザーガイド | 16時間 | ☐ |
| **合計** | **25タスク** | **200時間** | **0/25** |

---

**前のフェーズ**: [Phase 3: ファイル操作機能実装](./phase-3-file-operations.md)
**次のフェーズ**: [Phase 5: ターミナル・ビルド機能実装](./phase-5-terminal-build.md)
