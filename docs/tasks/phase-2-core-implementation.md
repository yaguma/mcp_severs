# Phase 2: コア機能実装（約1ヶ月）

**期間**: 2025年12月 - 2026年1月
**目標**: MCPサーバーの中核となるプロトコル層とアダプター層の実装

---

## タスク一覧

### Week 1: MCPサーバー基盤実装（5日間）

#### Day 26: MCPサーバーメインクラスの実装
- **タスク**: MCPサーバーの基幹クラスを実装する
- **成果物**: `src/server/MCPServer.ts`
  - `IMCPServer` インターフェースの実装
  - `start()` / `stop()` メソッド
  - ツール登録機構
  - リクエスト受信処理
- **依存関係**: Phase 1 完了
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] サーバーが正常に起動・停止できること
  - [ ] MCPプロトコルのハンドシェイクが成功すること
  - [ ] 単体テストが作成されていること

---

#### Day 27: リクエストハンドラーの実装
- **タスク**: MCP リクエストをルーティングするハンドラーを実装する
- **成果物**: `src/server/RequestHandler.ts`
  - リクエストのパース
  - ツールへのルーティング
  - エラーハンドリング
  - 監査ログの記録
- **依存関係**: Day 26
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] JSON-RPC リクエストが正しくパースできること
  - [ ] 不正なリクエストがエラーとして処理されること
  - [ ] すべてのリクエストがログに記録されること
  - [ ] 単体テストが作成されていること

---

#### Day 28: レスポンスフォーマッターの実装
- **タスク**: MCPレスポンスの整形とシリアライズを実装する
- **成果物**: `src/server/ResponseFormatter.ts`
  - 成功レスポンスの生成
  - エラーレスポンスの生成
  - JSON-RPC 形式への変換
  - タイムスタンプ付与
- **依存関係**: Day 27
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] MCPプロトコルに準拠したレスポンスが生成できること
  - [ ] エラー情報が適切にフォーマットされること
  - [ ] 単体テストが作成されていること

---

#### Day 29: セキュリティバリデーターの統合
- **タスク**: リクエストハンドラーにセキュリティバリデーションを統合する
- **成果物**: `src/security/SecurityValidator.ts`
  - パス検証
  - コマンド検証
  - 操作ログ記録
  - 統合テスト
- **依存関係**: Day 28
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのファイル操作でパス検証が実行されること
  - [ ] すべてのコマンド実行で危険コマンド検証が実行されること
  - [ ] 検証失敗時に適切なエラーが返ること
  - [ ] 統合テストが作成されていること

---

#### Day 30: ツール定義の実装
- **タスク**: MCPツールの定義とスキーマを実装する
- **成果物**: `src/server/tools/`
  - `tool-definitions.ts` (11種類のツール定義)
  - 各ツールのJSONスキーマ
  - `listTools()` メソッドの実装
- **依存関係**: Day 29
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 11種類のツール定義が完成していること
  - [ ] 各ツールのJSONスキーマが設計書通りであること
  - [ ] `listTools()` で全ツールが返却されること
  - [ ] 単体テストが作成されていること

---

### Week 2: エディタアダプター基盤（5日間）

#### Day 31: エディタアダプター抽象クラスの実装
- **タスク**: エディタアダプターの抽象化層を実装する
- **成果物**: `src/adapters/EditorAdapter.ts`
  - `IEditorAdapter` インターフェースの実装
  - 抽象メソッドの定義
  - エディタタイプの列挙
- **依存関係**: Day 30
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] エディタ非依存のインターフェースが定義されていること
  - [ ] 派生クラスで実装すべきメソッドが明確であること

---

#### Day 32: ファイルシステムアダプターの実装（VS Code用）
- **タスク**: VS Code のファイルシステムAPIを抽象化する
- **成果物**: `src/adapters/VSCodeFileSystemAdapter.ts`
  - `IFileSystemAdapter` の実装
  - `workspace.fs` APIのラッピング
  - エラーハンドリング
- **依存関係**: Day 31
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイル読み書きが正常に動作すること
  - [ ] ディレクトリ作成・削除が正常に動作すること
  - [ ] エラーが適切にハンドリングされること
  - [ ] 単体テストが作成されていること

---

#### Day 33: テキストエディタアダプターの実装（VS Code用）
- **タスク**: VS Code のテキストエディタAPIを抽象化する
- **成果物**: `src/adapters/VSCodeTextEditorAdapter.ts`
  - `ITextEditorAdapter` の実装
  - `TextDocument` の抽象化
  - `WorkspaceEdit` の抽象化
  - インデント設定の取得
- **依存関係**: Day 32
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ドキュメントの開閉が正常に動作すること
  - [ ] テキスト編集が正常に動作すること
  - [ ] インデント設定が取得できること
  - [ ] 単体テストが作成されていること

---

#### Day 34: ターミナルアダプターの実装（VS Code用）
- **タスク**: VS Code のターミナルAPIを抽象化する
- **成果物**: `src/adapters/VSCodeTerminalAdapter.ts`
  - `ITerminalAdapter` の実装
  - コマンド実行処理
  - stdout/stderr のキャプチャ
  - タイムアウト処理
- **依存関係**: Day 33
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] コマンドが正常に実行できること
  - [ ] stdout/stderr が正しくキャプチャできること
  - [ ] タイムアウトが正常に動作すること
  - [ ] 単体テストが作成されていること

---

#### Day 35: 診断情報アダプターの実装（VS Code用）
- **タスク**: VS Code の診断APIを抽象化する
- **成果物**: `src/adapters/VSCodeDiagnosticsAdapter.ts`
  - `IDiagnosticsAdapter` の実装
  - 診断情報の取得
  - コードアクション（QuickFix）の取得
- **依存関係**: Day 34
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] ファイルの診断情報が取得できること
  - [ ] プロジェクト全体の診断情報が取得できること
  - [ ] QuickFixが取得できること
  - [ ] 単体テストが作成されていること

---

### Week 3: VS Code アダプター統合（5日間）

#### Day 36: VS Code アダプター統合クラスの実装
- **タスク**: すべてのVS Codeアダプターを統合する
- **成果物**: `src/adapters/VSCodeAdapter.ts`
  - `IEditorAdapter` の完全実装
  - サブアダプターの初期化
  - VS Code拡張APIへの接続
- **依存関係**: Day 35
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] VSCodeAdapterが正常に初期化できること
  - [ ] すべてのサブアダプターが利用可能であること
  - [ ] VS Code API接続が成功すること
  - [ ] 統合テストが作成されていること

---

#### Day 37: エディタアダプターファクトリーの実装
- **タスク**: エディタタイプに応じたアダプターを生成するファクトリーを実装する
- **成果物**: `src/adapters/EditorAdapterFactory.ts`
  - エディタタイプの検出
  - 適切なアダプターの生成
  - Unity Editor 対応の準備（スタブ）
- **依存関係**: Day 36
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] VS Code アダプターが正しく生成されること
  - [ ] 未サポートエディタの場合にエラーが返ること
  - [ ] 単体テストが作成されていること

---

#### Day 38: 接続管理・再接続機能の実装
- **タスク**: エディタとの接続管理と自動再接続を実装する
- **成果物**: `src/server/ConnectionManager.ts`
  - 接続状態の監視
  - ハートビート機能
  - 自動再接続ロジック
  - 最大リトライ回数の制御
- **依存関係**: Day 37
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 接続断が検出されること
  - [ ] 自動再接続が試行されること
  - [ ] ハートビートが定期的に送信されること
  - [ ] 単体テストが作成されていること

---

#### Day 39: 設定管理機能の実装
- **タスク**: エディタ設定の取得と管理機能を実装する
- **成果物**: `src/config/EditorConfigManager.ts`
  - エディタ設定の取得
  - ワークスペース設定の取得
  - インデント設定の管理
  - フォーマット設定の管理
- **依存関係**: Day 38
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] エディタの設定が取得できること
  - [ ] タブ/スペース設定が取得できること
  - [ ] フォーマッター設定が取得できること
  - [ ] 単体テストが作成されていること

---

#### Day 40: ワークスペース管理機能の実装
- **タスク**: マルチワークスペース対応の基盤を実装する
- **成果物**: `src/server/WorkspaceManager.ts`
  - 複数ワークスペースの検出
  - アクティブワークスペースの管理
  - ワークスペース切り替え機能
- **依存関係**: Day 39
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 複数ワークスペースが検出できること
  - [ ] アクティブなワークスペースが特定できること
  - [ ] ワークスペースごとのプロジェクトルートが取得できること
  - [ ] 単体テストが作成されていること

---

### Week 4: マネージャー基盤実装（5日間）

#### Day 41: ファイル操作マネージャーの骨格実装
- **タスク**: `IFileOperationManager` の基本実装を行う
- **成果物**: `src/managers/FileOperationManager.ts`
  - クラス構造の定義
  - エディタアダプターとの連携
  - セキュリティバリデーターとの統合
- **依存関係**: Day 40
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] FileOperationManagerクラスが定義されていること
  - [ ] エディタアダプターを依存注入できること
  - [ ] パス検証が統合されていること

---

#### Day 42: コードエディタマネージャーの骨格実装
- **タスク**: `ICodeEditorManager` の基本実装を行う
- **成果物**: `src/managers/CodeEditorManager.ts`
  - クラス構造の定義
  - テキストエディタアダプターとの連携
  - インデント処理の準備
- **依存関係**: Day 41
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] CodeEditorManagerクラスが定義されていること
  - [ ] エディタアダプターを依存注入できること
  - [ ] インデント設定を取得できること

---

#### Day 43: ターミナル実行マネージャーの骨格実装
- **タスク**: `ITerminalExecutor` の基本実装を行う
- **成果物**: `src/managers/TerminalExecutor.ts`
  - クラス構造の定義
  - ターミナルアダプターとの連携
  - コマンドサニタイゼーションの統合
- **依存関係**: Day 42
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] TerminalExecutorクラスが定義されていること
  - [ ] エディタアダプターを依存注入できること
  - [ ] コマンド検証が統合されていること

---

#### Day 44: 診断情報プロバイダーの骨格実装
- **タスク**: `IDiagnosticsProvider` の基本実装を行う
- **成果物**: `src/managers/DiagnosticsProvider.ts`
  - クラス構造の定義
  - 診断アダプターとの連携
  - QuickFix管理の準備
- **依存関係**: Day 43
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] DiagnosticsProviderクラスが定義されていること
  - [ ] エディタアダプターを依存注入できること
  - [ ] 診断情報を取得できる構造になっていること

---

#### Day 45: 依存性注入コンテナの実装
- **タスク**: すべてのコンポーネントを統合するDIコンテナを実装する
- **成果物**: `src/di/Container.ts`
  - サービスの登録
  - 依存関係の解決
  - シングルトン管理
  - ファクトリーメソッド
- **依存関係**: Day 44
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのマネージャーが登録できること
  - [ ] 依存関係が自動解決されること
  - [ ] シングルトンが正しく機能すること
  - [ ] 単体テストが作成されていること

---

### Week 5: 統合とテスト（5日間）

#### Day 46: サーバー起動・初期化フローの実装
- **タスク**: サーバーの起動から初期化までの完全なフローを実装する
- **成果物**: `src/index.ts`
  - メインエントリポイント
  - 環境変数の読み込み
  - DIコンテナの初期化
  - MCPサーバーの起動
- **依存関係**: Day 45
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] サーバーが正常に起動すること
  - [ ] 環境変数が正しく読み込まれること
  - [ ] すべてのコンポーネントが初期化されること
  - [ ] エラー時に適切なログが出力されること

---

#### Day 47: E2Eテストの基盤構築
- **タスク**: VS Codeとの統合E2Eテスト環境を構築する
- **成果物**: `tests/e2e/`
  - VS Code拡張テストランナーの設定
  - テストワークスペースの準備
  - E2Eテストヘルパー関数
- **依存関係**: Day 46
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] E2Eテストが実行できる環境が整っていること
  - [ ] テストワークスペースが用意されていること
  - [ ] VS Code拡張としてテストが実行できること

---

#### Day 48: 統合テストの作成
- **タスク**: Phase 2 全体の統合テストを作成する
- **成果物**: `tests/integration/phase2.test.ts`
  - MCPサーバー起動テスト
  - ツールリスト取得テスト
  - リクエスト/レスポンステスト
  - エラーハンドリングテスト
- **依存関係**: Day 47
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] サーバーが正常に起動・停止すること
  - [ ] ツールリストが取得できること
  - [ ] リクエストが正しく処理されること
  - [ ] エラーが適切にハンドリングされること

---

#### Day 49: パフォーマンステストの実施
- **タスク**: レスポンスタイムとスループットのテストを実施する
- **成果物**: `tests/performance/phase2-perf.test.ts`
  - 起動時間の測定
  - リクエスト処理時間の測定
  - 同時実行テスト
  - メモリ使用量の測定
- **依存関係**: Day 48
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] 起動時間が5秒以内であること
  - [ ] リクエスト処理が設計書の目標値以内であること
  - [ ] 10並列リクエストが正常に処理できること
  - [ ] メモリリークがないこと

---

#### Day 50: Phase 2 総合テストとドキュメント整備
- **タスク**: Phase 2の完了確認とドキュメント更新
- **成果物**:
  - Phase 2完了レポート
  - APIドキュメント
  - 実装ガイド
  - トラブルシューティングガイド
- **依存関係**: Day 49
- **所要時間**: 1日
- **受け入れ基準**:
  - [ ] すべてのテストがパスすること
  - [ ] テストカバレッジが80%以上であること
  - [ ] APIドキュメントが整備されていること
  - [ ] ビルドエラーがないこと
  - [ ] Lintエラーがないこと

---

## Phase 2 完了基準

- [ ] MCPサーバーのコア機能が実装されている
- [ ] リクエストハンドラーとレスポンスフォーマッターが実装されている
- [ ] VS Code アダプター（4種類）が実装されている
- [ ] セキュリティバリデーションが統合されている
- [ ] 接続管理・再接続機能が実装されている
- [ ] DIコンテナが実装されている
- [ ] すべてのマネージャーの骨格が実装されている
- [ ] 単体テストカバレッジが80%以上
- [ ] 統合テストがパスする
- [ ] E2Eテスト環境が整っている
- [ ] パフォーマンス要件を満たしている

---

## Phase 2 成果物サマリー

| カテゴリ | 成果物 | 完了 |
|---------|--------|------|
| MCPサーバー | MCPServer, RequestHandler, ResponseFormatter | ☐ |
| セキュリティ | SecurityValidator統合 | ☐ |
| アダプター | VSCodeAdapter (4種類) | ☐ |
| マネージャー骨格 | FileOperationManager, CodeEditorManager, TerminalExecutor, DiagnosticsProvider | ☐ |
| インフラ | ConnectionManager, WorkspaceManager, DIContainer | ☐ |
| テスト | 単体テスト、統合テスト、E2Eテスト基盤 | ☐ |
| ドキュメント | APIドキュメント、実装ガイド | ☐ |

---

**前のフェーズ**: [Phase 1: プロジェクトセットアップ](./phase-1-project-setup.md)
**次のフェーズ**: [Phase 3: ファイル操作機能実装](./phase-3-file-operations.md)
